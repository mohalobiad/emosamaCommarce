# مشكلة تكرار الوصف في وصف الخيارات (Variations)

## ملخص سريع
- عند تفعيل العربية، كان فلتر **`woocommerce_short_description`** في الإضافة يحقن "الوصف القصير العربي" حتى عندما يكون النص المفلتر هو "وصف الخيار" (variation description).
- WooCommerce يمرر وصف كل خيار عبر نفس الفلتر `woocommerce_short_description` أثناء بناء بيانات الخيارات في `wc_get_formatted_variation()`، لكنه يفعل ذلك بينما يظل `$product` هو المنتج الأب وليس الـ variation.
- نتيجة ذلك: شرط التحقق من نوع المنتج (`product_variation`) لم يلتقط السياق الصحيح، فيتم استبدال وصف الخيار بالقيمة العربية للوصف القصير المخزنة للمنتج الأب.

## كيف تظهر المشكلة؟
1. منتج متغير مع خيارات لا تحتوي على وصف عربي خاص بالخيارات.
2. إضافة "الوصف القصير العربي" للمنتج الأب.
3. عند عرض صفحة المنتج بالعربية، يمر WooCommerce بوصف كل خيار داخل `woocommerce_short_description`.
4. لأن `$product` ما زال يشير للمنتج الأب، الفلتر يعيد الوصف القصير العربي الخاص بالأب، فيصبح وصف الخيار مطابقًا للوصف القصير العربي.

## الحل المطبق في الكود
- إضافة فحص سياق عبر `tpplt_is_variation_description_context()` الذي يقرأ جزءًا صغيرًا من الـ backtrace:
  - إذا وجد استدعاء `wc_get_formatted_variation()` أو `WC_Product_Variation::get_description()` نعلم أننا داخل تنسيق وصف خيار.
  - في هذا السياق نتجاوز الفلتر ولا نحقن الوصف القصير العربي.

## ماذا تفعل الآن؟
1. **سحب آخر نسخة من الكود** (التعديل موجود هنا).
2. جرّب سيناريو المنتج المتغير السابق:
   - أبقِ وصف الخيارات فارغًا أو ضع نصًا مختلفًا لكل خيار.
   - تأكد من وجود "الوصف القصير العربي" للمنتج الأب.
3. اعرض المنتج بالعربية وتحقق أن وصف كل خيار يعرض نصه الصحيح أو يبقى فارغًا، ولا يأخذ قيمة الوصف القصير العربي.
4. إن كنت تريد ترجمة وصف خيار بعينه للعربية، أضفه مباشرة في حقل وصف ذلك الخيار (meta `_variation_description`).

## ملاحظات تقنية
- لا يوجد أي تغيير في حفظ البيانات أو في حقول الترجمة؛ التغيير محصور في فلتر العرض فقط.
- التحقق يعتمد على backtrace محدود بـ 10 إطارات لتقليل أي تكلفة أداء.
